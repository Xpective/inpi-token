<!doctype html>
<html lang="de">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>INPI – QR</title>
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0b1420;color:#e6eefb;font:16px/1.45 system-ui,Segoe UI,Roboto}
  main{padding:14px}
  .card{background:#0f1a2a;border:1px solid #15263e;border-radius:10px;padding:1rem;margin:1rem}
  canvas{width:240px;height:240px;background:#fff;border-radius:8px}
  .muted{color:#9cb3ce}
  button{border:1px solid #244466;background:#14263c;color:#e6eefb;padding:.45rem .75rem;border-radius:8px;cursor:pointer}
</style>
<body>
<header style="display:flex;justify-content:space-between;align-items:center;padding:.7rem 1rem;border-bottom:1px solid #15263e">
  <b>INPI – Zahlungs-QR</b><button onclick="window.close()">Schließen</button>
</header>
<main>
  <div class="card">
    <div id="status" class="muted">Warte auf QR …</div>
  </div>
  <section id="cardContrib" class="card" style="display:none">
    <canvas id="qr"></canvas>
    <p class="muted">Scanne den QR mit deiner Wallet-App (SPL-USDC).</p>
  </section>
</main>
<script>
  const withVer = u=> u+(u.includes("?")?"&":"?")+"v="+Date.now();
  function ensureQR(){ return new Promise(res=>{ if(window.QRCode) return res(true); const s=document.createElement("script"); s.src=withVer("https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"); s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s); }); }
  async function draw(text){ await ensureQR(); const c=document.getElementById("qr"); await QRCode.toCanvas(c, text, {width:240,margin:1}); }
  window.addEventListener("message", async (ev)=>{
    if (ev.origin !== location.origin) return;
    const d=ev.data||{};
    if (d.type==="final_qr" && d.url){ document.getElementById("cardContrib").style.display="block"; await draw(d.url); document.getElementById("status").textContent="✅ QR aktiv."; }
  });
  // ping parent
  try{ window.opener && window.opener.postMessage({type:"popup_ready"}, location.origin); }catch{}
</script>
</body>
</html>