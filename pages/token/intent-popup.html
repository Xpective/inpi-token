<!-- /pages/token/intent-popup.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>INPI – Zahlung QR</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0b1420; color:#e6eefb;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header, footer{ padding:.8rem 1rem; border-bottom:1px solid #132235; }
    footer{ border-top:1px solid #132235; border-bottom:none; margin-top:auto; font-size:.85rem; color:#9cb3ce; }
    h1{ font-size:1.05rem; margin:0; font-weight:600; letter-spacing:.2px; }
    main{ padding:1rem; display:grid; gap:1rem; }
    .card{
      background:#0f1a2a; border:1px solid #15263e; border-radius:10px;
      padding:1rem; display:flex; flex-direction:column; gap:.6rem;
    }
    .row{ display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    canvas.qr{ width:240px; height:240px; background:#fff; border-radius:8px; }
    .muted{ color:#9cb3ce; font-size:.92rem; }
    .ok{ color:#7ee787; }
    .warn{ color:#ffb86b; }
    .err{ color:#ff6b6b; }
    button{
      appearance:none; border:1px solid #244466; background:#14263c; color:#e6eefb;
      padding:.45rem .75rem; border-radius:8px; cursor:pointer; font-weight:600;
    }
    button:hover{ background:#18314f; }
    small.code{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hidden{ display:none !important; }
    .k{ font-weight:600; }
  </style>
  <script>
    /* ===== Version/Caching ===== */
    const APP_VER = (window.opener && window.opener.APP_VER) || new Date().toISOString().slice(0,10);
    const withVer = (u)=> u + (u.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(APP_VER);

    /* ===== Minimal QR Loader (IIFE, CSP-freundlich) ===== */
    let QRCodeLib=null;
    function ensureQR(){
      return new Promise((resolve)=>{
        if (window.QRCode){ QRCodeLib = window.QRCode; return resolve(true); }
        const s = document.createElement("script");
        s.src = withVer("https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js");
        s.async = true;
        s.onload = ()=>{ QRCodeLib = window.QRCode; resolve(!!QRCodeLib); };
        s.onerror = ()=> resolve(false);
        document.head.appendChild(s);
      });
    }
    function toCanvas(el){
      if (!el) return null;
      if (el.tagName === "CANVAS") return el;
      const c = document.createElement("canvas");
      c.width=240; c.height=240; c.className = (el.className||"") + " qr";
      c.id = el.id || "";
      el.replaceWith(c); return c;
    }
    async function drawQR(imgOrCanvas, text, size=240){
      if (!text) return;
      let node = imgOrCanvas;
      if (!(node && node.isConnected) && node?.id) node = document.getElementById(node.id);
      const c = toCanvas(node); if (!c) return;
      await ensureQR();
      await QRCodeLib.toCanvas(c, text, { width:size, margin:1 });
      c.style.display = "block";
    }

    /* ===== UI helpers ===== */
    const $ = (s)=> document.querySelector(s);
    const el = (id)=> document.getElementById(id);

    function setText(id, txt){ const n = el(id); if (n) n.textContent = txt; }

    function showContrib(url){
      const card = el("cardContrib");
      card.classList.remove("hidden");
      drawQR(el("qr_contrib"), url, 240);
    }
    function showFee(url){
      const card = el("cardFee");
      card.classList.remove("hidden");
      drawQR(el("qr_fee"), url, 240);
    }

    /* ===== Messaging (Parent → Popup) ===== */
    function postReady(){
      try{ window.opener && window.opener.postMessage({ type:"popup_ready" }, window.location.origin); }catch{}
    }
    function handleMsg(ev){
      if (ev.origin !== window.location.origin) return;
      const d = ev.data || {};
      if (d.type === "hydrate"){
        const cache = d.data || {};
        if (cache.optimisticQR) {
          showContrib(cache.optimisticQR);
          setText("status", "Optimistic QR aktiv – warte auf Bestätigung …");
        }
        if (cache.finalQR){
          showContrib(cache.finalQR);
          setText("status", "✅ Finaler QR aktiv.");
        }
      }
      if (d.type === "optimistic_qr"){
        showContrib(d.url);
        setText("status", "Optimistic QR aktiv – warte auf Bestätigung …");
      }
      if (d.type === "final_qr"){
        showContrib(d.url);
        setText("status", "✅ Finaler QR aktiv.");
      }
      if (d.type === "fee_qr"){
        showFee(d.url);
      }
    }

    /* ===== Copy helpers (kein Link-Open) ===== */
    async function copyTxt(txt){
      try { await navigator.clipboard.writeText(txt); return true; } catch { return false; }
    }

    /* ===== Boot ===== */
    window.addEventListener("DOMContentLoaded", ()=>{
      window.addEventListener("message", handleMsg);
      postReady();

      // Copy-Buttons
      el("copy_contrib").addEventListener("click", async ()=>{
        const alt = el("qr_contrib_alt").textContent.trim();
        const ok = await copyTxt(alt);
        const b = el("copy_contrib"); const old = b.textContent;
        b.textContent = ok ? "Kopiert ✓" : "Kopieren fehlgeschlagen";
        setTimeout(()=> b.textContent = old, 900);
      });
      el("copy_fee").addEventListener("click", async ()=>{
        const alt = el("qr_fee_alt").textContent.trim();
        const ok = await copyTxt(alt);
        const b = el("copy_fee"); const old = b.textContent;
        b.textContent = ok ? "Kopiert ✓" : "Kopieren fehlgeschlagen";
        setTimeout(()=> b.textContent = old, 900);
      });
      el("btnClose").addEventListener("click", ()=> window.close());
    });
  </script>
</head>
<body>
  <header class="row" style="justify-content:space-between">
    <h1>INPI – Zahlungs-QR</h1>
    <button id="btnClose" title="Fenster schließen">Schließen</button>
  </header>

  <main>
    <div class="card">
      <div id="status" class="muted">Warte auf QR …</div>
      <small class="muted">Hinweis: Es werden nur QR-Codes angezeigt (keine Links).</small>
    </div>

    <section id="cardContrib" class="card hidden" aria-live="polite">
      <div class="row">
        <canvas id="qr_contrib" class="qr" width="240" height="240"></canvas>
        <div style="flex:1; min-width:180px">
          <div class="k">Presale Zahlung</div>
          <p class="muted" style="margin:.35rem 0 0">
            Scanne den QR mit deiner Wallet-App (SPL-USDC).<br/>
            <small class="muted">Keine Links, nur QR.</small>
          </p>
          <details style="margin-top:.5rem">
            <summary class="muted">QR-Payload anzeigen</summary>
            <small id="qr_contrib_alt" class="code muted"></small>
          </details>
          <div style="margin-top:.5rem">
            <button id="copy_contrib">QR-Payload kopieren</button>
          </div>
        </div>
      </div>
    </section>

    <section id="cardFee" class="card hidden" aria-live="polite">
      <div class="row">
        <canvas id="qr_fee" class="qr" width="240" height="240"></canvas>
        <div style="flex:1; min-width:180px">
          <div class="k">Optional: Early-Claim Fee (1 USDC)</div>
          <p class="muted" style="margin:.35rem 0 0">
            Scanne den zweiten QR, um den Early-Claim zu aktivieren.
          </p>
          <details style="margin-top:.5rem">
            <summary class="muted">QR-Payload anzeigen</summary>
            <small id="qr_fee_alt" class="code muted"></small>
          </details>
          <div style="margin-top:.5rem">
            <button id="copy_fee">QR-Payload kopieren</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Version: <span id="v"></span>
    <script>
      // Fülle Alt-Text der QRs live (damit Copy auch ohne sichtbaren QR klappt)
      const setAlt = (id, u)=> { const n = document.getElementById(id); if (n) n.textContent = u || ""; };
      window.addEventListener("message", (ev)=>{
        if (ev.origin !== window.location.origin) return;
        const d = ev.data || {};
        if (d.type === "hydrate" && d.data){
          if (d.data.optimisticQR) setAlt("qr_contrib_alt", d.data.optimisticQR);
          if (d.data.finalQR) setAlt("qr_contrib_alt", d.data.finalQR);
        }
        if (d.type === "optimistic_qr"){ setAlt("qr_contrib_alt", d.url); }
        if (d.type === "final_qr"){ setAlt("qr_contrib_alt", d.url); }
        if (d.type === "fee_qr"){ setAlt("qr_fee_alt", d.url); }
      });
      document.getElementById("v").textContent = APP_VER;
    </script>
  </footer>
</body>
</html>